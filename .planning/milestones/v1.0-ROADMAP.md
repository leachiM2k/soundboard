# Roadmap: iPhone Soundboard PWA

## Overview

Three phases deliver the complete soundboard. Phase 1 builds the audio and storage pipeline — the iOS Safari constraints (AudioContext unlock, MIME type detection, IndexedDB persistence) must be correct before any UI is layered on top. Phase 2 builds all visible tile behavior on the verified audio foundation. Phase 3 makes the app installable and offline-capable via service worker.

## Phases

**Phase Numbering:**
- Integer phases (1, 2, 3): Planned milestone work
- Decimal phases (2.1, 2.2): Urgent insertions (marked with INSERTED)

Decimal phases appear between their surrounding integers in numeric order.

- [x] **Phase 1: Audio and Storage Pipeline** - Record, store, and play audio with correct iOS Safari behavior (completed 2026-02-22)
- [x] **Phase 2: Tile UI and Interaction** - 3x3 grid with tap, long-press, visual states, and haptic feedback (completed 2026-02-22)
- [x] **Phase 3: PWA Shell and Offline** - Service worker, manifest, home screen install, offline capability (completed 2026-02-22)

## Phase Details

### Phase 1: Audio and Storage Pipeline
**Goal**: Users can record a sound into a tile and play it back, with audio and data surviving app restarts
**Depends on**: Nothing (first phase)
**Requirements**: REC-01, REC-02, REC-04, STOR-01, STOR-02, STOR-03, PLAY-01, PLAY-02
**Success Criteria** (what must be TRUE):
  1. Tapping an empty tile starts a microphone recording; tapping it again stops and saves the audio
  2. Tapping a filled tile plays back the recorded sound; tapping it again during playback stops and restarts from the beginning
  3. Microphone permission is requested only on the first record attempt, not on app load
  4. Recordings survive a full app restart and remain mapped to their original tile position
  5. Audio blobs are stored locally in IndexedDB with no data sent to any server
**Plans**: 4 plans

Plans:
- [x] 01-01-PLAN.md — Scaffold Vite 7 + TypeScript project, idb-keyval storage layer, MIME type detection
- [x] 01-02-PLAN.md — Recorder module: getMicrophoneStream (lazy, cached) + startRecording (30s auto-stop, iOS guards)
- [x] 01-03-PLAN.md — Player module: AudioContext singleton, playBlob with AudioBuffer cache, stopTile
- [x] 01-04-PLAN.md — State machine + app bootstrap harness + iPhone Safari verification checkpoint

### Phase 2: Tile UI and Interaction
**Goal**: Users see a clear 3x3 grid, understand tile state at a glance, and can manage recordings via long-press
**Depends on**: Phase 1
**Requirements**: GRID-01, GRID-02, REC-03, MGMT-01, MGMT-02, PLAY-03
**Success Criteria** (what must be TRUE):
  1. App shows exactly 9 tiles in a 3x3 grid on a single screen with no scrolling
  2. Empty and filled tiles are visually distinct at a glance
  3. An actively recording tile shows a pulsing visual indicator while the mic is live
  4. Long-pressing a filled tile opens a context menu offering Delete and Re-record
  5. Tapping any tile produces a brief haptic vibration on supported devices
**Plans**: 4 plans

Plans:
- [x] 02-01-PLAN.md — Data type extensions (label field) + long-press detector + haptic utility
- [x] 02-02-PLAN.md — HTML/CSS grid layout + tile visual states + tile.ts/grid.ts UI modules
- [x] 02-03-PLAN.md — Action sheet + rename dialog + main.ts full wiring
- [x] 02-04-PLAN.md — iPhone Safari verification checkpoint (9 tests)

### Phase 3: PWA Shell and Offline
**Goal**: Users can install the app to their iPhone Home Screen and use it offline
**Depends on**: Phase 2
**Requirements**: PWA-01, PWA-02, PWA-03
**Success Criteria** (what must be TRUE):
  1. The app can be added to the iPhone Home Screen via Safari and launches in standalone mode
  2. The app works fully offline after the initial load — all tiles, playback, and recording function without a network connection
  3. A one-time "Add to Home Screen" prompt appears when the user opens the app in Safari browser mode
**Plans**: 3 plans

Plans:
- [x] 03-01-PLAN.md — Install vite-plugin-pwa, generate icons, configure manifest + SW, offline.html, iOS meta tags
- [x] 03-02-PLAN.md — Install banner (once-per-day, post-first-tap, not in standalone) + wake lock during recording
- [x] 03-03-PLAN.md — iPhone Safari verification checkpoint (4 tests: install, offline, banner, wake lock)

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 1. Audio and Storage Pipeline | 4/4 | Complete | 2026-02-22 |
| 2. Tile UI and Interaction | 4/4 | Complete | 2026-02-22 |
| 3. PWA Shell and Offline | 3/3 | Complete | 2026-02-22 |

---

## Milestone Summary

**Status:** ✅ SHIPPED 2026-02-22
**Total:** 3 phases, 11 plans, ~1,250 LOC TypeScript

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| Web Audio API over HTMLAudioElement | 300-500ms iOS latency with HTMLAudioElement; AudioContext required from day one | ✓ Good — zero latency issues |
| Build audio pipeline before UI | iOS Safari AudioContext/MediaRecorder pitfalls have HIGH recovery cost if found late | ✓ Good — zero rework needed |
| Manual Vite scaffold | npm create vite cancelled on non-empty directory | ✓ Good — straightforward workaround |
| MIME probe order: webm/opus > webm > mp4 > ogg/opus | Covers all browsers; iOS Safari mp4 fallback correct | ✓ Good — works on all test devices |
| AudioBuffer cached per tile | Balances startup speed and repeat-play latency | ✓ Good — no perceptible latency |
| touchend not passive | Needs preventDefault() to suppress iOS synthetic click after long-press | ✓ Good — no double-trigger |
| Clone-before-wire for dialog buttons | Eliminates stale listener accumulation on repeated showModal() | ✓ Good — no event leaks |
| ngrok over self-signed certs | Avoids certificate warnings in Safari; simpler iPhone testing | ✓ Good — confirmed as project standard |
| registerType autoUpdate | Silent background updates; no user prompt | ✓ Good — seamless for PWA |
| navigateFallback to offline.html | Branded offline page for uncached URLs | ✓ Good — verified on device |

**Technical Debt:**

- `warningActive` flag set in main.ts at 25s mark but not consumed by tile.ts — no visual differentiation beyond timer countdown
- `shouldShowInstallBanner` exported from install-banner.ts but only used internally — unnecessary export

**Issues Resolved:**

- iOS getUserMedia HTTPS requirement → resolved with ngrok tunnel (replaced self-signed cert approach)
- @vite-pwa/assets-generator silent failure → resolved with ImageMagick

**Issues Deferred:**

- UX-01: Real-time waveform visualization (AnalyserNode + Canvas)
- UX-02: Confirmation dialog on recording delete
- UX-03: Pre-loaded AudioBuffer cache on startup
- RES-01: getUserMedia re-permission bug (WebKit #215884) in standalone mode

---

_For current project status, see .planning/ROADMAP.md_
