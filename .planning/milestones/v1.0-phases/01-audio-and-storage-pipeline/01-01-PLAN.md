---
phase: 01-audio-and-storage-pipeline
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - vite.config.ts
  - index.html
  - src/audio/format.ts
  - src/storage/db.ts
autonomous: true
requirements:
  - STOR-01
  - STOR-02
  - STOR-03

must_haves:
  truths:
    - "Running `npm run dev` starts a Vite dev server with no TypeScript errors"
    - "idb-keyval is installed and importable without errors"
    - "RECORDING_MIME_TYPE is detected at startup via isTypeSupported() (not hardcoded)"
    - "loadAllSlots() returns an array of 9 items (undefined for empty slots) from IndexedDB"
    - "saveSlot() persists a SlotRecord to IndexedDB under the tile's integer key"
    - "navigator.storage.persist() is called on first user interaction (not on startup)"
  artifacts:
    - path: "package.json"
      provides: "Project manifest with idb-keyval dependency and npm scripts"
      contains: "idb-keyval"
    - path: "tsconfig.json"
      provides: "TypeScript config targeting ES2020+ with strict mode"
      contains: "strict"
    - path: "vite.config.ts"
      provides: "Vite 7 config for Vanilla TS"
      contains: "defineConfig"
    - path: "index.html"
      provides: "Entry HTML with viewport meta for mobile"
      contains: "viewport"
    - path: "src/audio/format.ts"
      provides: "MIME type detection constant and detectSupportedMimeType()"
      exports: ["RECORDING_MIME_TYPE", "detectSupportedMimeType"]
    - path: "src/storage/db.ts"
      provides: "idb-keyval typed wrapper for 9-slot storage"
      exports: ["SlotRecord", "loadAllSlots", "saveSlot", "deleteSlot", "requestStoragePersistence"]
  key_links:
    - from: "src/storage/db.ts"
      to: "idb-keyval"
      via: "import { get, set, del, getMany } from 'idb-keyval'"
      pattern: "from 'idb-keyval'"
    - from: "src/storage/db.ts"
      to: "src/audio/format.ts"
      via: "SlotRecord.mimeType stores detected MIME type"
      pattern: "mimeType.*string"
---

<objective>
Scaffold the Vanilla TypeScript + Vite 7 project and build the storage foundation: MIME type detection and the idb-keyval storage layer.

Purpose: Everything else in this phase depends on these artifacts existing. The storage layer must be correct and tested before the recorder and player modules are built on top of it. The MIME type detection runs at startup so all modules can import a single constant.

Output: A buildable TypeScript project with idb-keyval installed, format detection at `src/audio/format.ts`, and the complete 9-slot storage layer at `src/storage/db.ts`.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-audio-and-storage-pipeline/01-CONTEXT.md
@.planning/phases/01-audio-and-storage-pipeline/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Vanilla TypeScript + Vite 7 project</name>
  <files>
    package.json
    tsconfig.json
    vite.config.ts
    index.html
    src/main.ts
  </files>
  <action>
Initialize the project with Vanilla TypeScript using Vite 7. Run from the project root (/Users/rotmanov/git/private/soundboard):

```bash
npm create vite@latest . -- --template vanilla-ts
npm install
npm install idb-keyval@6.2.2
```

After scaffolding, update these files:

**package.json** — verify scripts include `"dev"`, `"build"`, `"preview"`. Add `"type": "module"` if not present. Node 20.19+ is required by Vite 7.

**tsconfig.json** — ensure these compiler options are set:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "strict": true
  }
}
```

**vite.config.ts** — minimal config, no framework plugins needed:
```typescript
import { defineConfig } from 'vite';
export default defineConfig({});
```

**index.html** — replace the scaffolded body content with a minimal test harness (9 buttons). Keep the Vite-generated `<script type="module" src="/src/main.ts">` tag. Add the mobile viewport meta if not present:
```html
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
```

Body content for Phase 1 test harness (minimal, no visual polish — Phase 2 replaces this):
```html
<div id="app">
  <p id="status">Soundboard — Phase 1 Test Harness</p>
  <div id="tiles"></div>
  <p id="error-hint" style="display:none;color:red;"></p>
</div>
```

**src/main.ts** — placeholder that imports nothing yet (will be wired in Plan 04). Just log a startup message:
```typescript
console.log('Soundboard Phase 1 — engine loading');
```

Delete any scaffolded counter, style imports, or TypeScript Counter example files that Vite generates (counter.ts, typescript.svg, vite.svg, style.css if unused). Keep the project clean.
  </action>
  <verify>
Run from /Users/rotmanov/git/private/soundboard:
```bash
npm run build
```
Build must complete with zero TypeScript errors and zero Vite errors. Also confirm idb-keyval is in node_modules:
```bash
ls node_modules/idb-keyval/package.json
```
  </verify>
  <done>
`npm run build` exits 0. `node_modules/idb-keyval/package.json` exists. `src/main.ts` exists and compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: MIME type detection and idb-keyval storage layer</name>
  <files>
    src/audio/format.ts
    src/storage/db.ts
  </files>
  <action>
Create two modules that form the foundation for all audio operations.

**src/audio/format.ts** — MIME type detection, runs once at module load:

```typescript
// Probe MediaRecorder.isTypeSupported() in priority order.
// iOS Safari supports only audio/mp4 (AAC). Chrome/Firefox support audio/webm.
// The detected type is exported as a constant for all modules to import.
// Never hardcode a MIME type — it WILL fail on at least one major browser.

const PREFERRED_MIME_TYPES = [
  'audio/webm;codecs=opus', // Chrome, Firefox, Edge (best quality/size)
  'audio/webm',             // Chrome fallback
  'audio/mp4',              // iOS Safari (AAC inside MP4 container)
  'audio/ogg;codecs=opus',  // Firefox fallback
] as const;

export function detectSupportedMimeType(): string {
  if (typeof MediaRecorder === 'undefined') return '';
  for (const type of PREFERRED_MIME_TYPES) {
    if (MediaRecorder.isTypeSupported(type)) {
      return type;
    }
  }
  return ''; // Browser chooses — last resort only
}

// Called once at module load. All modules import this constant.
export const RECORDING_MIME_TYPE: string = detectSupportedMimeType();
```

**src/storage/db.ts** — idb-keyval typed wrapper for the 9-slot storage:

```typescript
// idb-keyval stores SlotRecords at integer keys 0-8 (one per tile).
// Uses the default keyval-store — no custom store needed for 9 keys.
// All persistence operations go through this module exclusively.

import { get, set, del, getMany } from 'idb-keyval';

export interface SlotRecord {
  blob: Blob;        // Raw audio blob from MediaRecorder
  mimeType: string;  // Detected at recording time; required for correct playback
  recordedAt: number; // Date.now() at recording completion
}

// SlotIndex is 0-8, mapping directly to tile positions in the 3x3 grid.
// Using number (not a union type) to allow runtime-computed indices.
export type SlotIndex = 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8;

/** Load all 9 slots in a single IndexedDB transaction. Returns undefined for empty slots. */
export async function loadAllSlots(): Promise<(SlotRecord | undefined)[]> {
  return getMany([0, 1, 2, 3, 4, 5, 6, 7, 8]);
}

/** Get a single slot. Returns undefined if empty. */
export async function loadSlot(index: SlotIndex): Promise<SlotRecord | undefined> {
  return get(index);
}

/** Persist a recording to the slot. Overwrites any existing recording at that position. */
export async function saveSlot(index: SlotIndex, record: SlotRecord): Promise<void> {
  await set(index, record);
}

/** Remove a slot's recording. The slot returns to empty state. */
export async function deleteSlot(index: SlotIndex): Promise<void> {
  await del(index);
}

/**
 * Request persistent IndexedDB storage to mitigate Safari's 7-day eviction in browser mode.
 * Call on first user interaction — NOT on app startup (reduces grant probability if called early).
 * Safari 17+ supports this; earlier versions resolve to false (no-op).
 * Home Screen PWA installs receive a higher storage quota regardless of this call.
 */
let persistenceRequested = false;
export async function requestStoragePersistence(): Promise<void> {
  if (persistenceRequested) return;
  persistenceRequested = true;
  if (!navigator.storage?.persist) return;
  const alreadyPersisted = await navigator.storage.persisted();
  if (!alreadyPersisted) {
    await navigator.storage.persist();
  }
}
```

Both files must compile with `strict: true`. No `any` types. No imports besides idb-keyval.
  </action>
  <verify>
Run from /Users/rotmanov/git/private/soundboard:
```bash
npm run build
```
Build must complete with zero errors. Confirm both files exist:
```bash
ls src/audio/format.ts src/storage/db.ts
```
  </verify>
  <done>
`npm run build` exits 0. Both `src/audio/format.ts` and `src/storage/db.ts` exist and compile without TypeScript errors. Exports `RECORDING_MIME_TYPE`, `detectSupportedMimeType`, `SlotRecord`, `loadAllSlots`, `saveSlot`, `deleteSlot`, `requestStoragePersistence` are present.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` exits 0 from the project root
2. `npm run dev` starts without errors (Vite dev server comes up)
3. `src/audio/format.ts` exports `RECORDING_MIME_TYPE` and `detectSupportedMimeType`
4. `src/storage/db.ts` exports `SlotRecord`, `SlotIndex`, `loadAllSlots`, `loadSlot`, `saveSlot`, `deleteSlot`, `requestStoragePersistence`
5. `node_modules/idb-keyval` is installed at version 6.2.2
6. No `any` types in TypeScript source files
</verification>

<success_criteria>
- Vite 7 project builds with zero TypeScript errors
- idb-keyval 6.2.2 is installed and importable
- MIME type detection module exists with the correct priority order (webm first, mp4 for iOS)
- Storage layer provides typed CRUD for all 9 tile slots
- `requestStoragePersistence()` is idempotent and guards against early calling
- Both modules compile under `strict: true` with no `any` types
</success_criteria>

<output>
After completion, create `.planning/phases/01-audio-and-storage-pipeline/01-01-SUMMARY.md` documenting:
- Exact Vite version scaffolded
- idb-keyval version installed
- MIME types in probe order
- All exported symbols from format.ts and db.ts
- Any deviations from the plan
</output>
