---
phase: 03-pwa-shell-and-offline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/install-banner.ts
  - src/audio/wake-lock.ts
  - src/main.ts
  - src/style.css
autonomous: true
requirements:
  - PWA-03

must_haves:
  truths:
    - "Install banner does not appear when app is launched in standalone mode"
    - "Install banner appears after the user's first tile tap (not on page load)"
    - "Install banner does not appear if it was already shown within the last 24 hours"
    - "Install banner has an X dismiss button that removes it and sets the shown timestamp"
    - "Screen wake lock is requested when recording starts and released when recording stops"
    - "Wake lock failure is non-fatal — recording continues if lock cannot be acquired"
  artifacts:
    - path: "src/ui/install-banner.ts"
      provides: "shouldShowInstallBanner(), showInstallBanner() — iOS-specific custom banner"
      exports: ["shouldShowInstallBanner", "showInstallBanner"]
    - path: "src/audio/wake-lock.ts"
      provides: "acquireWakeLock(), releaseWakeLock() — Screen Wake Lock with feature detection"
      exports: ["acquireWakeLock", "releaseWakeLock"]
    - path: "src/main.ts"
      provides: "Banner trigger after first tile tap; wake lock called in recording start/stop paths"
    - path: "src/style.css"
      provides: "#install-banner CSS — bottom-of-viewport, above Safari toolbar, dismiss button"
  key_links:
    - from: "src/main.ts"
      to: "src/ui/install-banner.ts"
      via: "showInstallBanner() called after first handleTileTap resolves"
      pattern: "showInstallBanner"
    - from: "src/main.ts"
      to: "src/audio/wake-lock.ts"
      via: "acquireWakeLock() in recording start path, releaseWakeLock() in onComplete"
      pattern: "acquireWakeLock|releaseWakeLock"
---

<objective>
Implement the custom iOS install banner (shown once per day after first tile tap, never in standalone mode) and the Screen Wake Lock integration for the recording flow.

Purpose: Satisfies PWA-03 (one-time install prompt in Safari browser mode). Wake Lock prevents screen sleep during recordings — quality-of-life for 30s recordings.
Output: src/ui/install-banner.ts, src/audio/wake-lock.ts, updated src/main.ts and src/style.css.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pwa-shell-and-offline/03-RESEARCH.md
@.planning/phases/03-pwa-shell-and-offline/03-CONTEXT.md
@src/main.ts
@src/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create install-banner.ts and wake-lock.ts modules</name>
  <files>src/ui/install-banner.ts, src/audio/wake-lock.ts</files>
  <action>
    **Create src/ui/install-banner.ts:**

    ```typescript
    // src/ui/install-banner.ts
    // Custom iOS install banner — iOS Safari does NOT support beforeinstallprompt.
    // Show once per day after first tile tap, never in standalone mode.

    const BANNER_LS_KEY = 'installBannerShownAt';
    const ONE_DAY_MS = 24 * 60 * 60 * 1000;

    function isStandalone(): boolean {
      // iOS Safari proprietary property
      const iosStandalone = (navigator as Navigator & { standalone?: boolean }).standalone === true;
      // Standard display-mode media query (Android + desktop Chrome)
      const displayModeStandalone = window.matchMedia('(display-mode: standalone)').matches;
      return iosStandalone || displayModeStandalone;
    }

    function wasShownToday(): boolean {
      const ts = localStorage.getItem(BANNER_LS_KEY);
      if (!ts) return false;
      return Date.now() - parseInt(ts, 10) < ONE_DAY_MS;
    }

    function markShown(): void {
      localStorage.setItem(BANNER_LS_KEY, String(Date.now()));
    }

    export function shouldShowInstallBanner(): boolean {
      return !isStandalone() && !wasShownToday();
    }

    export function showInstallBanner(): void {
      if (!shouldShowInstallBanner()) return;
      markShown();

      const banner = document.createElement('div');
      banner.id = 'install-banner';
      banner.setAttribute('role', 'banner');
      banner.innerHTML = `
        <span class="install-banner-text">
          <strong>↑ Teilen</strong> → <strong>Zum Home-Bildschirm</strong>
        </span>
        <button class="install-banner-close" aria-label="Schließen">✕</button>
      `;

      banner.querySelector<HTMLButtonElement>('.install-banner-close')!.addEventListener('click', () => {
        banner.remove();
      });

      document.body.appendChild(banner);
    }
    ```

    **Create src/audio/wake-lock.ts:**

    ```typescript
    // src/audio/wake-lock.ts
    // Screen Wake Lock API — prevents screen sleep during active recording.
    // Feature detection + try/catch: failure is non-fatal; recording continues.
    // Note: Wake Lock broken in iOS standalone PWA mode before iOS 18.4 (fixed March 2025).
    // Users on older iOS will not see errors — the lock simply fails silently.

    let wakeLock: WakeLockSentinel | null = null;

    export async function acquireWakeLock(): Promise<void> {
      if (!('wakeLock' in navigator)) return; // Not supported — silent no-op
      try {
        wakeLock = await navigator.wakeLock.request('screen');
      } catch {
        // NotAllowedError or other — non-fatal; recording continues without wake lock
      }
    }

    export async function releaseWakeLock(): Promise<void> {
      if (wakeLock) {
        try {
          await wakeLock.release();
        } catch {
          // Ignore release errors — sentinel may already be released (e.g., tab went hidden)
        }
        wakeLock = null;
      }
    }
    ```
  </action>
  <verify>
    Run: `npx tsc --noEmit` — TypeScript compilation passes with no errors for the new modules.
    Check: `ls src/ui/install-banner.ts src/audio/wake-lock.ts` — both files exist.
  </verify>
  <done>
    src/ui/install-banner.ts exports shouldShowInstallBanner() and showInstallBanner(). src/audio/wake-lock.ts exports acquireWakeLock() and releaseWakeLock(). Both compile without TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire install banner and wake lock into main.ts; add banner CSS</name>
  <files>src/main.ts, src/style.css</files>
  <action>
    **Update src/main.ts:**

    1. Add imports at the top of the file, alongside existing imports:
       ```typescript
       import { showInstallBanner, shouldShowInstallBanner } from './ui/install-banner';
       import { acquireWakeLock, releaseWakeLock } from './audio/wake-lock';
       ```

    2. Add a one-shot banner trigger mechanism. After the existing `const appState: AppState = createAppState();` line, add:
       ```typescript
       // Install banner: shown once per day after first user interaction, never in standalone
       let _bannerShown = false;
       function triggerInstallBannerOnce(): void {
         if (_bannerShown) return;
         _bannerShown = true;
         // Small delay so the tile tap animation completes first
         setTimeout(() => showInstallBanner(), 800);
       }
       ```

    3. In `handleTileTap()`, add `triggerInstallBannerOnce()` call immediately after `triggerHaptic()` (before any awaits):
       ```typescript
       async function handleTileTap(index: SlotIndex): Promise<void> {
         // CRITICAL: triggerHaptic MUST be called before any await — iOS requires user gesture
         triggerHaptic();
         triggerInstallBannerOnce();  // ← ADD THIS LINE

         await requestStoragePersistence();
         ...
       ```

    4. In the `'empty'` case of `handleTileTap` — the recording start path — add wake lock acquisition immediately before or after `startRecording(...)`:
       - After the `startRecording(...)` call returns `activeRecording`, call `acquireWakeLock()` (fire-and-forget, no await needed at that point):
         ```typescript
         const activeRecording = startRecording(stream, /* onComplete */ (result) => {
           // Release wake lock as soon as recording data is assembled
           void releaseWakeLock();
           stopRecordingTimer();
           ...
         }, /* onWarning */ () => { ... });

         // Acquire wake lock after recording has started (non-blocking)
         void acquireWakeLock();
         transitionTile(appState, index, 'recording', { activeRecording });
         updateTile(index, appState.tiles[index]);
         ```

       - Also call `releaseWakeLock()` in the `'recording'` case (manual stop path), before `transitionTile`:
         ```typescript
         case 'recording': {
           const current = appState.tiles[index];
           void releaseWakeLock();  // ← ADD THIS LINE (manual stop)
           current.activeRecording?.stop();
           transitionTile(appState, index, 'saving');
           updateTile(index, appState.tiles[index]);
           break;
         }
         ```

       Note: `void` operator is used for fire-and-forget async calls to satisfy TypeScript's no-floating-promises convention.

    **Update src/style.css — add install banner styles at the end of the file:**

    ```css
    /* ── Install banner ──────────────────────────────────────────── */
    #install-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      padding-bottom: calc(0.875rem + env(safe-area-inset-bottom));
      background: #1a1a2e;
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 0.875rem;
      line-height: 1.4;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
    }

    .install-banner-text {
      flex: 1;
    }

    .install-banner-close {
      flex-shrink: 0;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 1rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      line-height: 1;
      border-radius: 4px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .install-banner-close:active {
      background: rgba(255, 255, 255, 0.1);
    }
    ```

    Note on `env(safe-area-inset-bottom)`: This ensures the banner clears the Safari toolbar on iPhones with Home indicator (iPhone X and later). The `viewport-fit=cover` meta is already set in index.html, enabling `env()` support.
  </action>
  <verify>
    1. `npx tsc --noEmit` — TypeScript compilation passes with no errors.
    2. `npm run build` — build succeeds (plan 01 must be done or run independently; if vite-plugin-pwa not yet installed, build may fail — in that case just verify TypeScript passes).
    3. `grep "showInstallBanner\|triggerInstallBannerOnce" src/main.ts` — both present.
    4. `grep "acquireWakeLock\|releaseWakeLock" src/main.ts` — both present, appearing in recording start (empty case) and recording stop (recording case + onComplete).
    5. `grep "install-banner" src/style.css` — CSS rule present.
  </verify>
  <done>
    main.ts imports and calls showInstallBanner() (deferred 800ms, one-shot) after first tile tap. main.ts calls acquireWakeLock() when recording starts and releaseWakeLock() in both the onComplete callback and the manual recording stop path. src/style.css has #install-banner styles with safe-area-inset-bottom padding. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors across all source files.
2. `grep -c "acquireWakeLock\|releaseWakeLock" src/main.ts` — returns >= 3 (acquire once, release twice: onComplete + manual stop).
3. `grep "triggerInstallBannerOnce" src/main.ts` — present, called in handleTileTap after triggerHaptic().
4. `grep "safe-area-inset-bottom" src/style.css` — env() used for banner bottom padding.
5. `cat src/ui/install-banner.ts | grep "isStandalone\|wasShownToday\|markShown"` — all three guard functions present.
</verification>

<success_criteria>
- shouldShowInstallBanner() returns false when navigator.standalone is true
- shouldShowInstallBanner() returns false when localStorage has a timestamp within 24 hours
- showInstallBanner() creates #install-banner div and appends to body
- Dismiss button removes the banner
- acquireWakeLock() / releaseWakeLock() use feature detection with try/catch
- main.ts triggers banner once after first tile interaction (800ms delay, _bannerShown guard)
- main.ts acquires wake lock on recording start and releases on recording stop
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-pwa-shell-and-offline/03-02-SUMMARY.md`
</output>
