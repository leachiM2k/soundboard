---
phase: 04-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - src/ui/confirm-dialog.ts
  - src/ui/action-sheet.ts
  - src/main.ts
  - src/style.css
  - index.html
autonomous: true
requirements:
  - UX-01

must_haves:
  truths:
    - "Tapping Delete in the long-press menu shows a confirmation dialog before deleting the clip"
    - "Tapping Cancel in the confirm dialog closes it without deleting"
    - "The confirm dialog opens only after the action sheet has fully closed"
  artifacts:
    - path: "src/ui/confirm-dialog.ts"
      provides: "showConfirmDialog(message): Promise<boolean> using clone-before-wire pattern"
      exports: ["showConfirmDialog"]
    - path: "index.html"
      provides: "confirm-dialog <dialog> element with message, confirm, and cancel buttons"
      contains: "confirm-dialog"
  key_links:
    - from: "src/ui/action-sheet.ts"
      to: "src/ui/confirm-dialog.ts"
      via: "wireBtn('btn-delete', ...) handler calls showConfirmDialog after action sheet closes"
      pattern: "showConfirmDialog"
    - from: "src/ui/action-sheet.ts"
      to: "src/ui/confirm-dialog.ts"
      via: "wireBtn delete handler calls showConfirmDialog before invoking callbacks.onDelete"
      pattern: "showConfirmDialog.*confirmed"
---

<objective>
Implement the delete confirmation dialog so users cannot accidentally remove a clip.

Purpose: UX-01 — currently tapping Delete in the long-press menu immediately destroys the recording with no confirmation. This plan adds an async confirm step using the existing `<dialog>` + clone-before-wire pattern from rename-dialog.ts.
Output: showConfirmDialog module, index.html dialog markup, action-sheet.ts wire-up, main.ts delete guard, style.css dialog styles.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation/04-RESEARCH.md
@.planning/phases/04-foundation/04-01-SUMMARY.md

@src/ui/rename-dialog.ts
@src/ui/action-sheet.ts
@src/main.ts
@index.html
@src/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create confirm-dialog.ts and add dialog markup + styles</name>
  <files>src/ui/confirm-dialog.ts, index.html, src/style.css</files>
  <action>
    Create src/ui/confirm-dialog.ts implementing `showConfirmDialog(message: string): Promise<boolean>`. Follow the clone-before-wire pattern from `rename-dialog.ts` exactly:
    - Look up `#confirm-dialog` (HTMLDialogElement), `#confirm-dialog-message`, `#confirm-dialog-confirm`, `#confirm-dialog-cancel`
    - Set `msgEl.textContent = message`
    - Clone `btnConfirm` and `btnCancel` with `cloneNode(true)` and `replaceWith()` to prevent listener accumulation on repeated opens
    - Add click listeners: confirm → `dialog.close(); resolve(true)`, cancel → `dialog.close(); resolve(false)`
    - Add `dialog.addEventListener('close', () => resolve(false), { once: true })` as the safety net
    - Call `dialog.showModal()`
    - If any element is missing, `resolve(false)` immediately and return
    Export only `showConfirmDialog`.

    In index.html: Add the confirm dialog markup as a direct sibling of the existing `#action-sheet` and `#rename-dialog` elements (not nested inside them):
    ```html
    <dialog id="confirm-dialog" aria-modal="true">
      <div class="confirm-dialog-content">
        <p class="confirm-dialog-message" id="confirm-dialog-message"></p>
        <div class="confirm-dialog-actions">
          <button id="confirm-dialog-cancel">Abbrechen</button>
          <button id="confirm-dialog-confirm" class="destructive">Löschen</button>
        </div>
      </div>
    </dialog>
    ```

    In src/style.css: Add confirm dialog styles after the `#rename-dialog` styles section (mirror the rename-dialog pattern for visual consistency):
    ```css
    #confirm-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
      width: min(300px, 88vw);
      border: none;
      border-radius: 14px;
      background: #2c2c2e;
      padding: 20px;
    }
    #confirm-dialog::backdrop {
      background: rgba(0, 0, 0, 0.6);
    }
    .confirm-dialog-message {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.85);
      text-align: center;
      margin-bottom: 18px;
      line-height: 1.4;
    }
    .confirm-dialog-actions {
      display: flex;
      gap: 10px;
    }
    .confirm-dialog-actions button {
      flex: 1;
      padding: 11px 10px;
      font-size: 16px;
      font-family: inherit;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      background: #3a3a3c;
      color: rgba(255, 255, 255, 0.7);
    }
    .confirm-dialog-actions button.destructive {
      background: #ff3b30;
      color: #fff;
      font-weight: 600;
    }
    ```
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1</automated>
    <manual>grep -n "confirm-dialog" index.html src/ui/confirm-dialog.ts src/style.css — all three files must contain the confirm-dialog identifiers.</manual>
  </verify>
  <done>confirm-dialog.ts exports showConfirmDialog. index.html has the dialog markup. style.css has the dialog styles. Zero TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire delete confirmation in action-sheet.ts and main.ts</name>
  <files>src/ui/action-sheet.ts, src/main.ts</files>
  <action>
    In src/ui/action-sheet.ts:
    - Import `showConfirmDialog` from `./confirm-dialog`
    - Find the existing `wireBtn('btn-delete', callbacks.onDelete)` call (or equivalent direct wire)
    - Replace it so the delete button handler: closes the action sheet (already done by wireBtn's dialog.close() call before invoking handler), then calls `showConfirmDialog('Sound löschen?')`, then calls `callbacks.onDelete()` only if `confirmed === true`
    - Use `.then()` (not `await`) so the handler can remain synchronous at the call site:
      ```typescript
      wireBtn('btn-delete', () => {
        showConfirmDialog('Sound löschen?').then((confirmed) => {
          if (confirmed) callbacks.onDelete();
        });
      });
      ```
    - IMPORTANT: The action sheet `wireBtn` helper calls `dialog.close()` before invoking the handler — this ensures the action sheet is closed before `showConfirmDialog` opens the confirm dialog. Do NOT add an extra `dialog.close()` call.

    In src/main.ts:
    - Import `showConfirmDialog` from `./ui/confirm-dialog` (if not already imported via action-sheet)
    - Verify the existing `onDelete` callback in the `handleLongPress` / `showActionSheet` call site is still a plain `() => { deleteSlot(index)... }` handler (the guard is now in action-sheet.ts, so main.ts's onDelete should just perform the delete unconditionally)
    - The delete sequence in main.ts onDelete must remain: `deleteSlot(index)` → `clearAudioCache(index)` → `transitionTile(appState, index, 'empty')` → `updateTile(index, appState.tiles[index])`
    - Confirm there is NO second confirmation guard in main.ts (the guard is in action-sheet.ts — do not double-wrap)
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1</automated>
    <manual>npm run dev — long-press a recorded tile → tap Delete → confirm dialog appears with "Sound löschen?" message and Abbrechen/Löschen buttons → tap Abbrechen → tile still there → long-press again → tap Delete → tap Löschen → tile goes empty.</manual>
  </verify>
  <done>Delete requires two-tap confirmation. Cancel leaves clip intact. Confirm deletes immediately. TypeScript zero errors. No listener accumulation on repeated long-press/delete flows.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` exits 0
- `src/ui/confirm-dialog.ts` exists and exports `showConfirmDialog`
- `index.html` contains `id="confirm-dialog"`, `id="confirm-dialog-message"`, `id="confirm-dialog-confirm"`, `id="confirm-dialog-cancel"`
- `src/ui/action-sheet.ts` calls `showConfirmDialog` before `callbacks.onDelete()`
- `src/style.css` has `#confirm-dialog` and `.confirm-dialog-actions button.destructive` rules
</verification>

<success_criteria>
- UX-01: Delete in the action sheet now shows a confirm dialog before destroying the clip
- Cancelling leaves the tile and recording completely untouched
- Confirming executes the existing delete path (deleteSlot → clearAudioCache → transition to empty)
- No iOS two-dialog conflict (action sheet closed before confirm dialog opens)
- No listener accumulation on repeated delete flows
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation/04-02-SUMMARY.md` using the summary template.
</output>
