---
phase: 04-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - 04-01
  - 04-02
files_modified:
  - src/ui/action-sheet.ts
  - src/ui/tile.ts
  - src/main.ts
  - src/style.css
  - index.html
autonomous: true
requirements:
  - COLOR-01

must_haves:
  truths:
    - "User can pick one of the preset colors for a tile via the long-press action sheet"
    - "Chosen color is immediately applied to the tile face"
    - "Chosen color persists after app restart (stored in IndexedDB via SlotRecord.color)"
    - "Tapping the reset swatch restores the tile to its index-based default color"
    - "Existing v1.0 tiles without a stored color display correctly using the index-based default"
  artifacts:
    - path: "src/ui/action-sheet.ts"
      provides: "Color swatch row dynamically built from TILE_COLORS; onColorChange callback on ActionSheetCallbacks"
      contains: "onColorChange"
    - path: "src/ui/tile.ts"
      provides: "applyTileState reads tile.color with CSS.supports() validation, falls back to getTileColor(index)"
      contains: "CSS.supports"
    - path: "src/main.ts"
      provides: "handleColorChange saves updated SlotRecord to IndexedDB and updates tile state"
      contains: "handleColorChange"
  key_links:
    - from: "src/ui/action-sheet.ts"
      to: "src/main.ts"
      via: "onColorChange(color) callback calls handleColorChange(index, color)"
      pattern: "onColorChange"
    - from: "src/main.ts"
      to: "src/storage/db.ts"
      via: "handleColorChange calls saveSlot with updated record including color field"
      pattern: "saveSlot.*color"
    - from: "src/ui/tile.ts"
      to: "src/state/store.ts"
      via: "applyTileState reads tile.color; validated via CSS.supports before applying --tile-color"
      pattern: "CSS\\.supports"
---

<objective>
Implement the tile color picker: swatch row in the action sheet, CSS custom property update in tile rendering, and IndexedDB persistence.

Purpose: COLOR-01 — users can personalize each tile with one of the existing TILE_COLORS palette entries. The color is saved to SlotRecord.color (added in Plan 01) and survives app restarts. V1.0 tiles without a stored color continue to use the index-based default — no migration, no breaking changes.
Output: Color swatch row in action sheet, CSS.supports-guarded color application in tile.ts, handleColorChange in main.ts, style.css swatch styles, index.html swatch container.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation/04-RESEARCH.md
@.planning/phases/04-foundation/04-01-SUMMARY.md
@.planning/phases/04-foundation/04-02-SUMMARY.md

@src/ui/action-sheet.ts
@src/ui/tile.ts
@src/main.ts
@src/style.css
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add color swatch row to action sheet and update tile color application</name>
  <files>src/ui/action-sheet.ts, src/ui/tile.ts, index.html, src/style.css</files>
  <action>
    **src/ui/action-sheet.ts:**
    - Add `onColorChange: (color: string | undefined) => void` to the `ActionSheetCallbacks` interface (or equivalent callbacks type)
    - Import `TILE_COLORS` from `./tile`
    - In `showActionSheet` (or the function that wires the action sheet), add a section header and swatch row. Build the swatch row dynamically inside the function body (not once at init) to prevent listener accumulation on repeated opens:
      ```typescript
      const swatchRow = document.getElementById('action-sheet-colors');
      if (swatchRow) {
        swatchRow.innerHTML = '';
        // Reset swatch (restores index-based default)
        const resetBtn = document.createElement('button');
        resetBtn.className = 'color-swatch color-swatch--reset';
        resetBtn.title = 'Farbe zurücksetzen';
        resetBtn.setAttribute('aria-label', 'Farbe zurücksetzen');
        resetBtn.addEventListener('click', () => {
          dialog.close();
          callbacks.onColorChange(undefined);
        });
        swatchRow.appendChild(resetBtn);
        // Preset swatches from TILE_COLORS
        TILE_COLORS.forEach((color) => {
          const btn = document.createElement('button');
          btn.className = 'color-swatch';
          btn.style.background = color;
          btn.setAttribute('aria-label', color);
          // Highlight currently active color
          if (currentColor === color) {
            btn.classList.add('color-swatch--active');
          }
          btn.addEventListener('click', () => {
            dialog.close();
            callbacks.onColorChange(color);
          });
          swatchRow.appendChild(btn);
        });
      }
      ```
    - Pass `currentColor` (the tile's current `tile.color`) to `showActionSheet` so it can mark the active swatch. Add `currentColor?: string` to the showActionSheet parameter list (or existing params object).

    **index.html:**
    - Inside `.action-sheet-content` (the action sheet's inner container), add before the cancel button:
      ```html
      <p class="action-sheet-section-label">Farbe</p>
      <div class="action-sheet-colors" id="action-sheet-colors"></div>
      ```

    **src/ui/tile.ts:**
    - Update `applyTileState` to read `tile.color` with CSS.supports() validation:
      ```typescript
      if (tile.state === 'has-sound' || tile.state === 'playing') {
        const raw = tile.color;
        const validated = raw && CSS.supports('color', raw) ? raw : null;
        el.style.setProperty('--tile-color', validated ?? getTileColor(index));
      } else {
        el.style.removeProperty('--tile-color');
      }
      ```
    - Replace the existing `el.style.setProperty('--tile-color', getTileColor(index))` call (in the filled-state branch) with the CSS.supports-guarded version above.

    **src/style.css:**
    Add after the `.action-sheet-content` styles section:
    ```css
    .action-sheet-section-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.4);
      text-align: center;
      margin: 0;
      padding: 10px 16px 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .action-sheet-colors {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 12px 16px 14px;
      justify-content: center;
    }

    .color-swatch {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
    }

    .color-swatch:active {
      transform: scale(0.9);
    }

    .color-swatch--reset {
      background: #3a3a3c;
      position: relative;
    }

    .color-swatch--reset::after {
      content: '✕';
      font-size: 14px;
      color: rgba(255, 255, 255, 0.5);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .color-swatch--active {
      border-color: #ffffff;
    }
    ```
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1</automated>
    <manual>Check index.html has action-sheet-colors div; check action-sheet.ts builds swatches dynamically; check tile.ts uses CSS.supports guard.</manual>
  </verify>
  <done>Action sheet renders swatch row on open. tile.ts reads tile.color with CSS.supports validation. TypeScript zero errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire handleColorChange in main.ts for IndexedDB persistence</name>
  <files>src/main.ts</files>
  <action>
    In src/main.ts:

    1. Add `handleColorChange` function:
       ```typescript
       async function handleColorChange(index: SlotIndex, color: string | undefined): Promise<void> {
         const record = await loadSlot(index);
         if (!record) return;
         await saveSlot(index, { ...record, color });
         const tile = appState.tiles[index];
         tile.color = color;
         updateTile(index, tile);
       }
       ```
       `loadSlot` and `saveSlot` are already imported from `./storage/db`. `updateTile` is already imported from `./ui/grid`. `appState` is the existing module-level state.

    2. In the `showActionSheet` call site (inside `handleLongPress` or wherever action sheet is opened): add `onColorChange: (color) => { handleColorChange(index, color); }` to the callbacks object.

    3. Pass the current tile's color to `showActionSheet` as `currentColor`. The current tile data is accessible as `appState.tiles[index]`. Pass `appState.tiles[index].color` (may be undefined — that's correct, the reset swatch shows when no color is set).

    4. In the `loadAllSlots` bootstrap (DOMContentLoaded): confirm that `transitionTile` is called with `color: record.color` in the data parameter (added in Plan 01). No changes needed if Plan 01 already added this — just verify it is present.

    Note on color change and audio cache: color changes do NOT affect the audio blob — do NOT call `clearAudioCache` in `handleColorChange`. Only `saveSlot` updates the metadata.
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1</automated>
    <manual>npm run dev — long-press a recorded tile → swatch row visible with color circles → tap a color → tile immediately changes color → close and reopen app (restart dev server + reload) → tile shows the same color.</manual>
  </verify>
  <done>handleColorChange persists color to IndexedDB. Tile updates immediately after color pick. Color survives app restart. TypeScript zero errors.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` exits 0
- `src/ui/action-sheet.ts` has `onColorChange` in callbacks interface and rebuilds swatch row on every open
- `src/ui/tile.ts` `applyTileState` has `CSS.supports('color', raw)` guard before setting `--tile-color`
- `index.html` has `id="action-sheet-colors"` and `class="action-sheet-section-label"` elements inside action sheet
- `src/main.ts` has `handleColorChange` function that calls `saveSlot` with spread record + color
- `src/main.ts` `showActionSheet` call includes `onColorChange` callback and passes `currentColor`
- Color persists: loadAllSlots passes `color: record.color` in transitionTile data (from Plan 01)
</verification>

<success_criteria>
- COLOR-01: User picks a color in the long-press menu; tile face updates immediately; color survives app restart
- Reset swatch clears the user-chosen color and tile reverts to index-based default
- Active color swatch is highlighted with a white border ring
- V1.0 tiles without stored color display correctly (undefined → index default, no errors)
- No listener accumulation when opening the action sheet multiple times on the same tile
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation/04-03-SUMMARY.md` using the summary template.
</output>
