---
phase: 06-audio-operations
plan: 03
type: execute
wave: 3
depends_on:
  - 06-01
  - 06-02
files_modified:
  - src/ui/share.ts
  - src/main.ts
autonomous: false
requirements:
  - SHARE-01

must_haves:
  truths:
    - "User can tap 'Exportieren' in the long-press action sheet to share a clip"
    - "On iOS 15+ (canShare with files supported), the native iOS share sheet opens with the audio file"
    - "On iOS 14.x or when canShare returns false, a file download is triggered in browser mode"
    - "In standalone PWA mode, the download fallback is suppressed — only share sheet is offered"
    - "User cancelling the share sheet (AbortError) does not show an error"
  artifacts:
    - path: "src/ui/share.ts"
      provides: "exportClip(record, index) — Web Share Level 2 with canShare guard and download fallback; isStandaloneMode() helper"
      exports: ["exportClip", "isStandaloneMode"]
    - path: "src/main.ts"
      provides: "onExport wired in handleLongPress calling exportClip from share.ts"
  key_links:
    - from: "src/main.ts"
      to: "src/ui/share.ts"
      via: "handleLongPress onExport callback calls exportClip(record, index)"
      pattern: "exportClip"
    - from: "src/ui/share.ts"
      to: "navigator.share"
      via: "navigator.canShare?.({ files }) guard then navigator.share({ files, title })"
      pattern: "navigator\\.share|navigator\\.canShare"
---

<objective>
Implement SHARE-01: export a clip via the iOS share sheet (Web Share Level 2) with a download fallback for browser mode.

Purpose: Users on iOS 15+ can share any clip via the native share sheet. Older devices or browsers get a file download link. Standalone PWA mode suppresses the download fallback per requirements.
Output: src/ui/share.ts (new file); src/main.ts modified to wire onExport.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-audio-operations/06-RESEARCH.md
@.planning/phases/06-audio-operations/06-02-SUMMARY.md

@src/storage/db.ts
@src/main.ts
@src/ui/action-sheet.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/ui/share.ts — Web Share Level 2 with download fallback</name>
  <files>src/ui/share.ts</files>
  <action>
Create new file `src/ui/share.ts`. Implement two exports:

**`isStandaloneMode(): boolean`**
```typescript
export function isStandaloneMode(): boolean {
  return !!(window.navigator as { standalone?: boolean }).standalone
    || window.matchMedia('(display-mode: standalone)').matches;
}
```

**`exportClip(record: SlotRecord, index: number): void`**

Implement exactly following the RESEARCH.md "Web Share with Correct Gesture Pattern" code example. Key requirements:

1. Determine file extension from mimeType:
   - `mimeType.includes('mp4')` → `'m4a'`
   - `mimeType.includes('webm')` → `'webm'`
   - `mimeType.includes('ogg')` → `'ogg'`
   - fallback → `'audio'`
   - fileName: `sound-${index + 1}.${ext}`

2. Pre-create File object SYNCHRONOUSLY (no await before this — blob is already in record, no async needed):
   `const file = new File([record.blob], fileName, { type: record.mimeType });`

3. Check `isStandaloneMode()` for download suppression guard.

4. Attempt share if canShare supports files:
   ```typescript
   if (navigator.canShare?.({ files: [file] })) {
     navigator.share({ files: [file], title: fileName })
       .catch((err: Error) => {
         // AbortError = user cancelled — NOT an error, do nothing
         if (err.name !== 'AbortError' && !isStandalone) {
           triggerDownload(record.blob, fileName);
         }
       });
     return;
   }
   ```

5. Fallback for no share support:
   ```typescript
   if (!isStandalone) {
     triggerDownload(record.blob, fileName);
   }
   // Standalone + no share: do nothing (requirements: suppress download in standalone)
   ```

**`triggerDownload(blob: Blob, fileName: string): void`** (internal, not exported)

Follow RESEARCH.md pattern:
```typescript
function triggerDownload(blob: Blob, fileName: string): void {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}
```

CRITICAL CONSTRAINTS from STATE.md and RESEARCH.md:
- `exportClip` is called synchronously inside the click handler — do NOT add any await before calling navigator.share(). The blob is pre-loaded in tile.record — no async access needed.
- Guard `navigator.canShare?.()` not `navigator.canShare()` — canShare may not exist on iOS < 15.
- `URL.createObjectURL` is ONLY used in browser mode (not standalone) — enforced by the `if (!isStandalone)` guard.
- Swallow AbortError silently — user cancelling the share sheet is expected behavior.

Import SlotRecord from '../storage/db'.

Full module should be ~40 lines.
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1</automated>
    <manual>Verify share.ts exports exportClip and isStandaloneMode with correct TypeScript types</manual>
  </verify>
  <done>tsc --noEmit passes; src/ui/share.ts exists with exportClip and isStandaloneMode exports; no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Wire onExport in main.ts handleLongPress</name>
  <files>src/main.ts</files>
  <action>
Make two changes to src/main.ts:

**1. New import at top of file:**
```typescript
import { exportClip } from './ui/share';
```

**2. Add `onExport` to the callbacks in `showActionSheet(...)` call inside `handleLongPress`:**

Find the existing `showActionSheet(index, tile.label, record.durationSeconds, {` call. Add `onExport` after the existing `onTrim` callback (which was added in Plan 02):

```typescript
onExport: () => {
  exportClip(record, index);
},
```

CRITICAL: `exportClip` must be called synchronously inside the click handler — do NOT wrap it in `.then()`, `async`, or any `await`. The action sheet wireBtn handler calls this synchronously after `dialog.close()`. This preserves the user gesture context required by iOS for `navigator.share()`.

The `record` variable is already in scope at the top of `handleLongPress` (`const record = tile.record`).

Do NOT modify any other part of main.ts. The trim-related changes from Plan 02 must remain intact.
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1 && npm run build 2>&1 | tail -5</automated>
    <manual>In browser (non-standalone): long-press filled tile, tap "Exportieren" — verify download starts; on iPhone Safari standalone: tap "Exportieren" — verify iOS share sheet opens with audio file</manual>
  </verify>
  <done>tsc --noEmit passes; npm run build succeeds; onExport wired in handleLongPress; exportClip called synchronously in click handler</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: iPhone device verification — TRIM-01 and SHARE-01</name>
  <action>
Deploy production build to iPhone via ngrok for device verification:
```
npm run build && npx serve dist
```
In a second terminal: `ngrok http 3000`
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npm run build 2>&1 | tail -3</automated>
    <manual>
TRIM-01:
1. Record a new clip — verify "Stille entfernt" toast appears after recording
2. Tap Undo in toast — verify duration badge reverts to original
3. Long-press filled tile, tap "Stille kurzen" — verify trim applies, duration badge updates
4. Tap trimmed tile — verify audio starts immediately without leading silence

SHARE-01 (browser mode):
5. Long-press filled tile, tap "Exportieren"
6. iOS 15+: verify share sheet opens with audio file attachment
7. Cancel share sheet — verify no error
8. iOS 14.x: verify file download starts

SHARE-01 (standalone mode — add to Home Screen first):
9. Long-press, tap "Exportieren" — verify share sheet opens, no download link

Regression:
10. Record, play, re-record, rename, delete, color, progress ring, recording visualizer all work
    </manual>
  </verify>
  <done>Both TRIM-01 and SHARE-01 verified on real iPhone Safari; regression check passes; Phase 6 complete</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds
- SHARE-01: tap "Exportieren" in action sheet → iOS share sheet opens on iOS 15+ (standalone and browser)
- SHARE-01: in browser mode on unsupported device → file download offered
- SHARE-01: standalone mode → no download link, share-only
- SHARE-01: user cancels share sheet → no error shown
- TRIM-01: auto-trim fires after recording, toast visible, Undo works
- TRIM-01: manual trim via action sheet updates duration badge
- No regression in existing features (play, record, color, rename, delete, visualizer, progress ring)
</verification>

<success_criteria>
- tsc --noEmit and npm run build both pass
- SHARE-01 fully implemented: share sheet on iOS 15+, download fallback in browser mode, suppressed in standalone, AbortError swallowed
- iPhone device verification passes for both TRIM-01 and SHARE-01
- All v1.1 requirements (TRIM-01, SHARE-01) verified on real iPhone Safari
- Phase 6 complete — v1.1 milestone deliverable
</success_criteria>

<output>
After completion, create `.planning/phases/06-audio-operations/06-03-SUMMARY.md` using the summary template.
</output>
