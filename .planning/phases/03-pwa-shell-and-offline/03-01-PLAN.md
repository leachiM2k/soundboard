---
phase: 03-pwa-shell-and-offline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - index.html
  - public/apple-touch-icon.png
  - public/pwa-192x192.png
  - public/pwa-512x512.png
  - public/offline.html
autonomous: true
requirements:
  - PWA-01
  - PWA-02

must_haves:
  truths:
    - "App produces a web app manifest at /manifest.webmanifest after build"
    - "index.html contains apple-mobile-web-app-capable, apple-touch-icon link, and theme-color meta tags"
    - "Service worker is registered and precaches all JS, CSS, HTML, and PNG assets after build"
    - "Navigating to the app root while offline serves the app shell (not browser error page)"
    - "Navigating to an uncached URL offline serves public/offline.html"
    - "All three PNG icon files exist in public/ at the required sizes"
  artifacts:
    - path: "vite.config.ts"
      provides: "VitePWA plugin config with manifest, icons, workbox precache, navigateFallback"
      contains: "VitePWA"
    - path: "public/apple-touch-icon.png"
      provides: "iOS Home Screen icon (180x180 PNG)"
    - path: "public/pwa-192x192.png"
      provides: "PWA manifest icon 192x192 PNG"
    - path: "public/pwa-512x512.png"
      provides: "PWA manifest icon 512x512 PNG"
    - path: "public/offline.html"
      provides: "Branded offline fallback page served by service worker navigateFallback"
    - path: "index.html"
      provides: "iOS-required meta tags in <head>"
  key_links:
    - from: "vite.config.ts"
      to: "public/apple-touch-icon.png"
      via: "includeAssets in VitePWA config"
      pattern: "includeAssets.*apple-touch-icon"
    - from: "vite.config.ts"
      to: "public/offline.html"
      via: "workbox.navigateFallback"
      pattern: "navigateFallback.*offline\\.html"
    - from: "index.html"
      to: "public/apple-touch-icon.png"
      via: "link rel=apple-touch-icon"
      pattern: "apple-touch-icon"
---

<objective>
Install vite-plugin-pwa, configure the web app manifest and Workbox service worker, create all PNG icons, add iOS-specific meta tags to index.html, and create the offline fallback page.

Purpose: Makes the app eligible for "Add to Home Screen" on iOS Safari (PWA-01) and fully offline-capable after first load (PWA-02).
Output: vite.config.ts with VitePWA plugin, three PNG icons in public/, offline.html in public/, iOS meta tags in index.html.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pwa-shell-and-offline/03-RESEARCH.md
@.planning/phases/03-pwa-shell-and-offline/03-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-pwa and generate PNG icons</name>
  <files>public/apple-touch-icon.png, public/pwa-192x192.png, public/pwa-512x512.png</files>
  <action>
    1. Install vite-plugin-pwa 1.2.0 as a dev dependency:
       ```
       npm install -D vite-plugin-pwa@1.2.0
       ```

    2. Generate three PNG icons programmatically using a Node.js script (do NOT add extra dependencies — use the Canvas API via the `canvas` npm package which is already available in the Node ecosystem, OR use a pure approach: write a small Node script that uses `Jimp` or simply writes raw PNG bytes). The simplest approach: use the `@vite-pwa/assets-generator` CLI tool which is available as a one-time npx call.

       Run the assets generator from a source SVG. Since no SVG source exists yet, create `/public/icon.svg` first as a soundboard motif, then generate icons from it:

       **Create /public/icon.svg** — a minimal SVG soundboard icon:
       - Background: filled rounded-rect with color #ff6b35 (vibrant orange accent, per Claude's discretion matching the colorful tile aesthetic)
       - Foreground: a simple 3x3 dot grid (representing the 9 tiles) in white, centered
       - ViewBox: "0 0 512 512"
       - No external fonts or assets

       Example SVG structure:
       ```svg
       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
         <rect width="512" height="512" rx="80" fill="#ff6b35"/>
         <!-- 3x3 grid of white circles, centered, 52px radius each, 60px gap -->
         <!-- Row 1: y=148 -->
         <circle cx="148" cy="148" r="52" fill="white"/>
         <circle cx="256" cy="148" r="52" fill="white"/>
         <circle cx="364" cy="148" r="52" fill="white"/>
         <!-- Row 2: y=256 -->
         <circle cx="148" cy="256" r="52" fill="white"/>
         <circle cx="256" cy="256" r="52" fill="white"/>
         <circle cx="364" cy="256" r="52" fill="white"/>
         <!-- Row 3: y=364 -->
         <circle cx="148" cy="364" r="52" fill="white"/>
         <circle cx="256" cy="364" r="52" fill="white"/>
         <circle cx="364" cy="364" r="52" fill="white"/>
       </svg>
       ```

    3. Run the @vite-pwa/assets-generator to produce all icon sizes:
       ```
       npx --yes @vite-pwa/assets-generator --preset minimal --source public/icon.svg
       ```
       This generates: public/pwa-192x192.png, public/pwa-512x512.png, public/apple-touch-icon.png (180x180), and potentially others. If the generator does not create apple-touch-icon.png at 180x180 automatically, copy pwa-192x192.png to apple-touch-icon.png as a fallback (they are visually identical at these sizes).

       If `@vite-pwa/assets-generator` fails or is unavailable, use this fallback approach to create PNGs programmatically with sharp (npx approach):
       ```bash
       npx sharp-cli --input public/icon.svg --output public/pwa-192x192.png resize 192 192
       npx sharp-cli --input public/icon.svg --output public/pwa-512x512.png resize 512 512
       npx sharp-cli --input public/icon.svg --output public/apple-touch-icon.png resize 180 180
       ```

       If all programmatic approaches fail, as a last resort create minimal valid 1x1 white PNG files using Node.js Buffer (the smallest valid PNG is 67 bytes). However, prefer the SVG-to-PNG conversion path for real icon quality.

    4. Verify all three files exist and are non-zero in public/:
       - `public/apple-touch-icon.png` (expected ~10-50KB at 180x180)
       - `public/pwa-192x192.png` (expected ~10-50KB at 192x192)
       - `public/pwa-512x512.png` (expected ~50-200KB at 512x512)
  </action>
  <verify>
    Run: `ls -lh public/*.png` — all three files present and non-zero bytes.
    Run: `file public/apple-touch-icon.png` — output shows "PNG image data".
  </verify>
  <done>
    Three PNG icons exist in public/: apple-touch-icon.png, pwa-192x192.png, pwa-512x512.png. All are valid PNG files with non-zero file sizes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure VitePWA plugin and add iOS meta tags</name>
  <files>vite.config.ts, index.html, public/offline.html</files>
  <action>
    1. **Create public/offline.html** — branded offline fallback page. Dark navy background (#1a1a2e) matching theme_color, white text, system font. Content:
       ```html
       <!doctype html>
       <html lang="de">
         <head>
           <meta charset="UTF-8">
           <meta name="viewport" content="width=device-width, initial-scale=1.0">
           <title>Soundboard — Offline</title>
           <style>
             body {
               font-family: -apple-system, BlinkMacSystemFont, sans-serif;
               display: flex;
               flex-direction: column;
               align-items: center;
               justify-content: center;
               min-height: 100dvh;
               margin: 0;
               background: #1a1a2e;
               color: #ffffff;
               text-align: center;
               padding: 2rem;
               box-sizing: border-box;
             }
             h1 { font-size: 2rem; margin: 0 0 0.75rem; }
             p  { opacity: 0.7; max-width: 280px; line-height: 1.6; margin: 0; }
           </style>
         </head>
         <body>
           <h1>Soundboard</h1>
           <p>Öffne die App einmal online, um den Offline-Modus zu aktivieren.</p>
         </body>
       </html>
       ```

    2. **Update vite.config.ts** to add the VitePWA plugin. Replace the existing config entirely:
       ```typescript
       import { defineConfig } from 'vite';
       import { VitePWA } from 'vite-plugin-pwa';

       export default defineConfig({
         server: {
           allowedHosts: ['.ngrok-free.app'],
         },
         plugins: [
           VitePWA({
             registerType: 'autoUpdate',
             workbox: {
               globPatterns: ['**/*.{js,css,html,ico,png,svg}'],
               navigateFallback: 'offline.html',
               navigateFallbackDenylist: [],
             },
             includeAssets: ['apple-touch-icon.png', 'pwa-192x192.png', 'pwa-512x512.png'],
             manifest: {
               name: 'Soundboard',
               short_name: 'Soundboard',
               description: 'Record and play back sounds instantly.',
               display: 'standalone',
               start_url: '/',
               scope: '/',
               theme_color: '#1a1a2e',
               background_color: '#ff6b35',
               icons: [
                 {
                   src: 'pwa-192x192.png',
                   sizes: '192x192',
                   type: 'image/png',
                 },
                 {
                   src: 'pwa-512x512.png',
                   sizes: '512x512',
                   type: 'image/png',
                 },
                 {
                   src: 'pwa-512x512.png',
                   sizes: '512x512',
                   type: 'image/png',
                   purpose: 'maskable',
                 },
               ],
             },
           }),
         ],
       });
       ```

       **Do NOT add conflicting `skipWaiting` or `clientsClaim` to workbox config** — `registerType: 'autoUpdate'` handles this correctly in vite-plugin-pwa (per research anti-pattern note).

    3. **Update index.html** `<head>` section — add iOS-specific meta tags immediately after the existing `<meta name="viewport">` line:
       ```html
       <!-- PWA: iOS Home Screen support -->
       <meta name="apple-mobile-web-app-capable" content="yes">
       <meta name="apple-mobile-web-app-title" content="Soundboard">
       <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
       <meta name="theme-color" content="#1a1a2e">
       <link rel="apple-touch-icon" href="/apple-touch-icon.png">
       ```

       Do NOT remove or alter the existing viewport meta tag (`viewport-fit=cover` is already set and must be preserved).

    4. Run `npm run build` to verify the entire build succeeds with VitePWA:
       - Build should complete without errors
       - dist/ should contain: `sw.js`, `manifest.webmanifest`, icon PNGs, and `offline.html`
       - Check: `ls dist/ | grep -E 'sw|manifest|offline'`
       - If build errors about file size (Pitfall 6 — maximumFileSizeToCacheInBytes), add to workbox config: `maximumFileSizeToCacheInBytes: 5 * 1024 * 1024`
  </action>
  <verify>
    1. `npm run build` exits with code 0.
    2. `ls dist/ | grep sw` — sw.js present.
    3. `ls dist/ | grep manifest` — manifest.webmanifest present.
    4. `ls dist/offline.html` — offline fallback present.
    5. `grep "apple-mobile-web-app-capable" index.html` — meta tag present.
    6. `grep "apple-touch-icon" index.html` — link tag present.
    7. `grep "VitePWA" vite.config.ts` — plugin configured.
  </verify>
  <done>
    Build succeeds. dist/ contains sw.js and manifest.webmanifest. index.html has all iOS PWA meta tags. offline.html exists in public/ and dist/. vite.config.ts uses VitePWA with autoUpdate, precache glob, and navigateFallback pointing to offline.html.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` produces dist/ with sw.js, manifest.webmanifest, apple-touch-icon.png, pwa-192x192.png, pwa-512x512.png, offline.html.
2. `grep -c "apple-mobile-web-app" index.html` returns >= 3 (capable, title, status-bar-style).
3. `grep "apple-touch-icon" index.html` shows the link element.
4. `cat dist/manifest.webmanifest` — valid JSON with name, icons, display: standalone, start_url, theme_color.
5. All icon PNGs are non-zero bytes: `ls -lh public/*.png`.
</verification>

<success_criteria>
- npm run build completes without errors
- dist/ contains sw.js, manifest.webmanifest, and all three icon PNGs
- index.html has the 4 iOS meta tags + apple-touch-icon link
- public/offline.html exists with branded content in German
- vite.config.ts imports and configures VitePWA with autoUpdate, globPatterns, navigateFallback
</success_criteria>

<output>
After completion, create `.planning/phases/03-pwa-shell-and-offline/03-01-SUMMARY.md`
</output>
