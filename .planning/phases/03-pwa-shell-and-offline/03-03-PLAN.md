---
phase: 03-pwa-shell-and-offline
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
  - 03-02
files_modified: []
autonomous: false
requirements:
  - PWA-01
  - PWA-02
  - PWA-03

must_haves:
  truths:
    - "App can be added to iPhone Home Screen via Safari Share → Add to Home Screen"
    - "App launches in standalone mode (no Safari chrome) from the Home Screen icon"
    - "App icon on Home Screen shows the soundboard grid design, not a screenshot"
    - "All 9 tiles function correctly in standalone mode — tap, record, playback"
    - "App loads and all tiles display when Safari is in airplane mode (after one online load)"
    - "Install banner appears after first tile tap in Safari browser mode (not standalone)"
    - "Install banner does NOT appear when launched from Home Screen in standalone mode"
  artifacts:
    - path: "dist/sw.js"
      provides: "Service worker — verified active in DevTools Application panel"
    - path: "dist/manifest.webmanifest"
      provides: "Web app manifest — verified parseable by Safari"
    - path: "public/apple-touch-icon.png"
      provides: "Home Screen icon — verified shows correctly on iPhone"
  key_links:
    - from: "iPhone Home Screen"
      to: "app running standalone"
      via: "Safari Add to Home Screen flow"
      pattern: "standalone"
    - from: "airplane mode"
      to: "app loads from service worker cache"
      via: "service worker precache"
      pattern: "offline"
---

<objective>
Verify all Phase 3 PWA requirements on a real iPhone using ngrok HTTPS tunnel: installability, standalone mode, offline capability, and install banner behavior.

Purpose: Gate for Phase 3 completion — confirms all three PWA requirements (PWA-01, PWA-02, PWA-03) work on real iOS Safari, not just in the build output.
Output: Verified, complete soundboard PWA with iPhone confirmation.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pwa-shell-and-offline/03-01-SUMMARY.md
@.planning/phases/03-pwa-shell-and-offline/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start dev server and open ngrok tunnel</name>
  <files></files>
  <action>
    1. Start the Vite dev server:
       ```
       npm run dev
       ```
       Confirm it starts on localhost:5173 (or whatever port Vite selects).

    2. In a separate terminal, open an ngrok tunnel to the Vite dev port:
       ```
       ngrok http 5173
       ```
       Copy the HTTPS forwarding URL (e.g., https://xxxx.ngrok-free.app).

    3. Confirm the app loads in the local browser at the ngrok URL — app should show the 3x3 tile grid.

    Note: vite-plugin-pwa in dev mode uses `devOptions: { enabled: false }` by default (service worker not active in dev). For testing offline capability, the user must test against a production build served locally:
       ```
       npm run build && npx serve dist
       ```
       Then tunnel with ngrok to the serve port (default 3000).

    Output to user: the ngrok HTTPS URL to open on iPhone.
  </action>
  <verify>
    App loads at ngrok HTTPS URL in local browser. Terminal shows ngrok forwarding URL.
  </verify>
  <done>
    ngrok HTTPS URL is active and app loads correctly at that URL.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: iPhone Safari verification — installability, offline, install banner</name>
  <files></files>
  <action>
    Complete PWA shell has been built: web app manifest, service worker with precache, apple-touch-icon, iOS meta tags, install banner (once-per-day, after first tile tap, not in standalone), and screen wake lock during recording.

    For offline testing, serve the production build: `npm run build && npx serve dist` (then tunnel ngrok to port 3000).

    Open the ngrok HTTPS URL on iPhone in Safari.
  </action>
  <verify>
    **Test 1 — PWA-01: Add to Home Screen**
    1. Open the ngrok URL in Safari
    2. Tap the Share button (box with arrow)
    3. Scroll down and tap "Zum Home-Bildschirm hinzufügen" ("Add to Home Screen")
    4. Confirm the icon preview shows the soundboard grid design (not a screenshot)
    5. Tap "Hinzufügen" ("Add")
    6. Press the Home button and find the Soundboard icon
    7. Tap the icon — app should open WITHOUT Safari address bar/navigation chrome (standalone mode)
    8. PASS if: app launches fullscreen with no Safari UI, title bar shows "Soundboard"

    **Test 2 — PWA-02: Offline capability**
    (Requires production build: `npm run build && npx serve dist` + ngrok to port 3000)
    1. Open the app via ngrok URL in Safari (browser mode — NOT from Home Screen)
    2. Wait for the page to fully load (service worker installs in background)
    3. Enable Airplane Mode on iPhone
    4. Close and reopen Safari, navigate to the ngrok URL
    5. PASS if: app loads completely (not browser "offline" page)
    6. Verify: tap a tile — playback of previously recorded sounds works offline

    **Test 3 — PWA-03: Install banner**
    1. Open the app in Safari browser mode (not standalone — open via ngrok URL directly)
    2. Clear localStorage if needed: DevTools → Application → Local Storage → delete installBannerShownAt key
    3. Tap any tile
    4. PASS if: after ~800ms, a banner appears at the bottom with "↑ Teilen → Zum Home-Bildschirm" text and an X button
    5. Tap X — banner dismisses
    6. Reload page and tap a tile again — banner should NOT reappear (shown within 24 hours)
    7. Open app from Home Screen (standalone mode) and tap a tile — banner should NOT appear

    **Test 4 — Wake Lock**
    1. In Safari browser mode, tap an empty tile to start recording
    2. Leave the iPhone idle for ~30 seconds
    3. PASS if: screen does NOT dim/sleep during recording (may not work on iOS < 18.4 in standalone)
  </verify>
  <done>
    All four tests pass. Type "approved" if all tests pass. Describe any failures (e.g., "icon shows screenshot", "offline page shows browser error", "banner shows in standalone").
  </done>
</task>

</tasks>

<verification>
All three PWA requirements verified on real iPhone Safari:
- PWA-01: App installable and launches in standalone mode with correct icon
- PWA-02: App loads and functions fully offline after one online load
- PWA-03: Install banner appears once per day after first tile tap, not in standalone mode
</verification>

<success_criteria>
- iPhone can add the app to Home Screen and launch it in standalone mode (no Safari chrome)
- Home Screen icon shows the soundboard grid design
- App loads from service worker cache when offline (after one online load)
- Install banner appears after first tile tap in browser mode, dismissed with X
- Install banner does not appear in standalone mode
- All existing Phase 2 features (record, playback, long-press, rename, delete) still work in standalone mode
</success_criteria>

<output>
After completion, create `.planning/phases/03-pwa-shell-and-offline/03-03-SUMMARY.md`
</output>
