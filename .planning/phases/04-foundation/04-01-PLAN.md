---
phase: 04-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/storage/db.ts
  - src/state/store.ts
  - src/ui/tile.ts
  - src/main.ts
autonomous: true
requirements:
  - UX-02

must_haves:
  truths:
    - "Every occupied tile shows a clip-duration badge in both has-sound and playing states"
    - "Existing v1.0 records without a color field load without any error"
    - "The color field on SlotRecord and TileData is TypeScript-optional and accepts undefined"
  artifacts:
    - path: "src/storage/db.ts"
      provides: "SlotRecord interface with color?: string"
      contains: "color?: string"
    - path: "src/state/store.ts"
      provides: "TileData interface with color?: string; transitionTile preserves color in has-sound and playing branches"
      contains: "color?: string"
    - path: "src/ui/tile.ts"
      provides: "Duration badge rendered in playing branch of buildTileContent"
      contains: "tile-duration"
  key_links:
    - from: "src/state/store.ts"
      to: "src/storage/db.ts"
      via: "TileData.color mirrors SlotRecord.color optional field"
      pattern: "color\\?:\\s*string"
    - from: "src/ui/tile.ts"
      to: "src/state/store.ts"
      via: "playing branch reads tile.record?.durationSeconds"
      pattern: "tile\\.record\\?.durationSeconds"
---

<objective>
Lay the schema foundation for Phase 4 and fix the duration badge gap in the playing tile state.

Purpose: Every subsequent Phase 4 task reads SlotRecord.color and TileData.color — these must exist before confirm-dialog and color-picker plans run. The UX-02 duration badge fix is a one-liner that belongs here because it touches tile.ts independently of everything else.
Output: Extended SlotRecord + TileData types; transitionTile preserves color; duration badge visible on playing tiles.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation/04-RESEARCH.md

@src/storage/db.ts
@src/state/store.ts
@src/ui/tile.ts
@src/main.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SlotRecord and TileData with optional color field; preserve color in transitionTile</name>
  <files>src/storage/db.ts, src/state/store.ts</files>
  <action>
    In src/storage/db.ts: Add `color?: string;` as an optional field on the `SlotRecord` interface, after `label?: string`. Comment: `// NEW: user-chosen CSS color. undefined = use index-based default`.

    In src/state/store.ts: Add `color?: string;` as an optional field on the `TileData` interface, after `label?: string`. Comment: `// NEW: synced from SlotRecord.color`.

    In src/state/store.ts: In `transitionTile`, find the branch `} else if (newState === 'has-sound' || newState === 'playing') {` which already sets `next.label = data.label ?? tile.label;`. Add the line `next.color = data.color ?? tile.color;` immediately after it. This ensures the user-set color survives all state transitions (empty → has-sound → playing → has-sound round-trips).

    In src/main.ts: Find the `loadAllSlots` bootstrap (DOMContentLoaded handler) where `transitionTile` is called to restore saved slots. Pass `color: record.color` in the data argument so the initial tile state includes any stored color. For old v1.0 records, `record.color` is `undefined`, which is correct — `TileData.color` is optional.

    Backward compatibility: All reads of `record.color` and `tile.color` must use `?? fallback` (nullish coalescing). No migration script needed — idb-keyval stores plain objects; old records simply lack the field.
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1</automated>
    <manual>TypeScript reports zero errors. Both interfaces now have color?: string. store.ts transitionTile has the color preservation line.</manual>
  </verify>
  <done>SlotRecord and TileData each have `color?: string`. transitionTile forwards color in has-sound/playing branches. TypeScript compiles clean with zero errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add duration badge to playing tile state in buildTileContent</name>
  <files>src/ui/tile.ts</files>
  <action>
    In src/ui/tile.ts, find `buildTileContent`. Locate the `case 'playing':` branch. It currently returns a template string with `tile-icon` (▶) and `tile-label` but no duration badge.

    Apply this fix — mirror the `has-sound` branch which already renders `tile-duration`:

    ```typescript
    case 'playing': {
      const label = tile.label ?? `Slot ${index + 1}`;
      const dur = tile.record?.durationSeconds != null
        ? `<span class="tile-duration">${formatDuration(tile.record.durationSeconds)}</span>`
        : '';
      return `
        <span class="tile-icon">▶</span>
        <span class="tile-label">${escapeHtml(label)}</span>
        ${dur}
      `;
    }
    ```

    `formatDuration` is already imported/defined in `tile.ts`. `escapeHtml` is already in scope. `tile.record` is available because transitionTile sets it in the playing branch.

    Do not change any other branches. Do not change CSS classes.
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1</automated>
    <manual>npm run dev — record a sound, tap tile to play it — duration badge (e.g., "2.4s") appears on the tile face while audio plays.</manual>
  </verify>
  <done>playing branch of buildTileContent renders a tile-duration span when durationSeconds is set. TypeScript compiles clean.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` exits 0 (zero type errors)
- `SlotRecord` in src/storage/db.ts has `color?: string`
- `TileData` in src/state/store.ts has `color?: string`
- `transitionTile` has `next.color = data.color ?? tile.color;` in the has-sound/playing branch
- `case 'playing':` in buildTileContent renders `tile-duration` span when durationSeconds is present
- `main.ts` bootstrap passes `color: record.color` when calling transitionTile for saved slots
</verification>

<success_criteria>
- UX-02: Duration badge appears on playing tiles (was missing; has-sound branch was already correct)
- Schema: color?: string added to both SlotRecord and TileData with full backward compatibility
- Zero TypeScript errors after changes
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation/04-01-SUMMARY.md` using the summary template.
</output>
