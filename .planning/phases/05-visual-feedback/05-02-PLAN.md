---
phase: 05-visual-feedback
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/ui/viz-playback.ts
  - src/audio/player.ts
  - src/style.css
  - src/main.ts
autonomous: false
requirements:
  - UX-03

must_haves:
  truths:
    - "During playback, an SVG progress ring fills from 0% to 100% in real time on the playing tile"
    - "The progress ring disappears immediately when playback is stopped early (re-tap on playing tile)"
    - "The progress ring disappears when playback ends naturally (onEnded fires)"
    - "The progress ring is removed if playBlob throws (error path catch block)"
    - "Progress ring animation is capped at 30fps — no battery drain from 60fps redraw"
    - "The AudioContext currentTime clock (not Date.now) drives elapsed fraction — synchronized to audio hardware"
  artifacts:
    - path: "src/ui/viz-playback.ts"
      provides: "startPlaybackProgress(index, startCtxTime, durationSec) / stopPlaybackProgress(index) — SVG ring rAF loop"
      exports: ["startPlaybackProgress", "stopPlaybackProgress"]
    - path: "src/audio/player.ts"
      provides: "playBlob() extended with optional onStarted callback; exports startCtxTime and buffer.duration to caller"
      contains: "onStarted"
    - path: "src/style.css"
      provides: ".tile-progress-ring CSS rule (position absolute, centered, pointer-events none)"
      contains: ".tile-progress-ring"
    - path: "src/main.ts"
      provides: "onStarted callback passed to playBlob in both has-sound and playing cases; stopPlaybackProgress in onEnded and catch blocks"
  key_links:
    - from: "src/audio/player.ts (playBlob)"
      to: "src/ui/viz-playback.ts"
      via: "onStarted?(startCtxTime, audioBuffer.duration) called after source.start(0)"
      pattern: "onStarted"
    - from: "src/main.ts (has-sound onEnded)"
      to: "src/ui/viz-playback.ts"
      via: "stopPlaybackProgress(index) called before transitionTile in onEnded"
      pattern: "stopPlaybackProgress"
    - from: "src/main.ts (playing onEnded)"
      to: "src/ui/viz-playback.ts"
      via: "stopPlaybackProgress(index) called before transitionTile in onEnded"
      pattern: "stopPlaybackProgress"
    - from: "src/main.ts (playing re-tap)"
      to: "src/ui/viz-playback.ts"
      via: "stopPlaybackProgress(index) called before stopTile(index)"
      pattern: "stopPlaybackProgress"
    - from: "src/main.ts (catch blocks)"
      to: "src/ui/viz-playback.ts"
      via: "stopPlaybackProgress(index) in catch of both has-sound and playing playBlob calls"
      pattern: "stopPlaybackProgress"
---

<objective>
Implement UX-03: real-time SVG progress ring during audio playback.

Purpose: Users see a visual countdown ring on the playing tile, confirming playback is active and indicating how much of the clip remains. The ring disappears cleanly on natural end or early stop.

Output: `src/ui/viz-playback.ts` (standalone module), `player.ts` extended with `onStarted` callback, CSS ring style, and `main.ts` integration covering all playback stop paths.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-visual-feedback/05-RESEARCH.md
@.planning/phases/05-visual-feedback/05-01-SUMMARY.md

# Source files to modify
@src/audio/player.ts
@src/main.ts
@src/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create viz-playback.ts + extend player.ts with onStarted callback</name>
  <files>src/ui/viz-playback.ts, src/audio/player.ts</files>
  <action>
    **Part A — src/ui/viz-playback.ts:**

    Create a new module following Pattern 2 from RESEARCH.md. Key implementation rules:

    1. Import `getAudioContext` from `'../audio/player'`.

    2. SVG ring geometry constants at module level:
       ```typescript
       const RADIUS = 22; // px — fits inside smallest tile (iPhone SE ~115px tile)
       const CIRCUMFERENCE = 2 * Math.PI * RADIUS; // ~138.23px
       ```

    3. `startPlaybackProgress(index: number, startCtxTime: number, durationSec: number): void`
       - Call `stopPlaybackProgress(index)` first (idempotent)
       - Find tile element via `document.querySelector('[data-slot="${index}"]') as HTMLElement | null` — return early if null
       - Build SVG element (namespace `http://www.w3.org/2000/svg`):
         - `svg.setAttribute('class', 'tile-progress-ring')`
         - `svg.setAttribute('aria-hidden', 'true')`
         - `svg.setAttribute('viewBox', '0 0 52 52')`
       - Build circle element inside SVG:
         - `cx="26"`, `cy="26"`, `r="22"` (matches RADIUS)
         - `fill="none"`, `stroke="rgba(255,255,255,0.85)"`, `stroke-width="3"`, `stroke-linecap="round"`
         - `circle.style.strokeDasharray = String(CIRCUMFERENCE)`
         - `circle.style.strokeDashoffset = String(CIRCUMFERENCE)` (full offset = 0% progress = ring empty)
         - `circle.style.transform = 'rotate(-90deg)'` (start at top, not right)
         - `circle.style.transformOrigin = '50% 50%'`
       - Append circle to svg, append svg to tile element
       - rAF tick loop: cap at 30fps with `TARGET_INTERVAL_MS = 1000 / 30` and timestamp delta guard
       - Inside tick:
         - `const ctx = getAudioContext()`
         - `const elapsed = ctx.currentTime - startCtxTime` — use AudioContext clock (NOT Date.now — audio clock is synchronized to hardware)
         - `const fraction = Math.min(1, elapsed / durationSec)`
         - `circle.style.strokeDashoffset = String(CIRCUMFERENCE * (1 - fraction))` — fraction=0 → full offset (empty); fraction=1 → 0 offset (full)
         - When `fraction >= 1`: cancel rAF, remove svg, delete from map, return early
       - Store in `activeProgressMap.set(index, { stop: () => { cancelAnimationFrame(rafHandle); svg.remove(); } })`

    4. `stopPlaybackProgress(index: number): void`
       - Look up `activeProgressMap.get(index)`, call `.stop()`, then `activeProgressMap.delete(index)`
       - Safe to call when no progress is active (no-op)

    5. Module-level: `const activeProgressMap = new Map<number, { stop: () => void }>()`

    6. Export both functions.

    **Part B — src/audio/player.ts:**

    Extend `playBlob` with an optional `onStarted` callback using Option B from RESEARCH.md (callback keeps async return type unchanged and matches the existing `onEnded` callback pattern).

    Change the function signature from:
    ```typescript
    export async function playBlob(
      tileIndex: number,
      blob: Blob,
      onEnded: () => void,
    ): Promise<void>
    ```
    To:
    ```typescript
    export async function playBlob(
      tileIndex: number,
      blob: Blob,
      onEnded: () => void,
      onStarted?: (startCtxTime: number, durationSec: number) => void,
    ): Promise<void>
    ```

    After `source.start(0)`, capture the start time and invoke the callback:
    ```typescript
    source.start(0);
    const startCtxTime = ctx.currentTime; // capture AFTER start() — most accurate
    onStarted?.(startCtxTime, audioBuffer.duration);
    ```

    The `onStarted` call goes immediately after `source.start(0)` and before any other statements. The existing `source.onended`, `activeNodes.set`, and other logic remains unchanged.

    This is a backward-compatible change — existing callers that pass only 3 arguments continue to work.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check that viz-playback.ts exports startPlaybackProgress and stopPlaybackProgress; player.ts has onStarted parameter and call after source.start(0)</manual>
  </verify>
  <done>
    `src/ui/viz-playback.ts` compiles cleanly. `src/audio/player.ts` compiles cleanly with updated `playBlob` signature. `npx tsc --noEmit` exits 0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS ring rule + wire progress into main.ts all playback paths</name>
  <files>src/style.css, src/main.ts</files>
  <action>
    **Part A — src/style.css:**

    Append after the existing `.tile-viz-canvas` rule added in Plan 01:

    ```css
    /* UX-03: Playback progress ring overlay */
    .tile-progress-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 52px;
      height: 52px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      overflow: visible;
    }
    ```

    The tile already has `position: relative; overflow: hidden` from existing styles. The `overflow: visible` on the SVG prevents stroke edges from being clipped by the tile boundary.

    **Part B — src/main.ts:**

    Add import at top of file alongside existing UI imports (after the `startRecordingViz, stopRecordingViz` import added in Plan 01):
    ```typescript
    import { startPlaybackProgress, stopPlaybackProgress } from './ui/viz-playback';
    ```

    Wire `startPlaybackProgress` and `stopPlaybackProgress` into all 5 playback paths:

    **Path 1 — `has-sound` case, `onEnded` callback (inside `playBlob` call):**
    Call `stopPlaybackProgress(index)` before `transitionTile(appState, index, 'has-sound', { record })`.

    **Path 2 — `has-sound` case, `onStarted` callback (4th argument to `playBlob`):**
    Pass a new 4th argument to `playBlob`:
    ```typescript
    (startCtxTime, durationSec) => {
      startPlaybackProgress(index, startCtxTime, durationSec);
    }
    ```

    **Path 3 — `has-sound` case, `catch` block:**
    Call `stopPlaybackProgress(index)` before `transitionTile(appState, index, 'error', ...)`.

    **Path 4 — `playing` case (re-tap / restart), before `stopTile(index)`:**
    Call `stopPlaybackProgress(index)` before `stopTile(index)` — the ring from the interrupted playback must be removed before the tile restarts.
    Then pass `onStarted` and `onEnded` callbacks (with `stopPlaybackProgress`) to the second `playBlob` call in this case:
    - `onEnded`: call `stopPlaybackProgress(index)` before `transitionTile(appState, index, 'has-sound', { record })`
    - `onStarted` (4th arg): call `startPlaybackProgress(index, startCtxTime, durationSec)`

    **Path 5 — `playing` case (re-tap), `catch` block:**
    Call `stopPlaybackProgress(index)` before `transitionTile(appState, index, 'error', ...)`.

    Summary of all `stopPlaybackProgress` call sites in main.ts (5 total):
    1. `has-sound` onEnded — before transitionTile to has-sound
    2. `has-sound` catch — before transitionTile to error
    3. `playing` re-tap — before stopTile (for the interrupted ring)
    4. `playing` onEnded — before transitionTile to has-sound
    5. `playing` catch — before transitionTile to error

    Summary of all `startPlaybackProgress` call sites (2 total, via onStarted):
    1. `has-sound` onStarted (4th arg to playBlob)
    2. `playing` onStarted (4th arg to playBlob, for the restarted playback)

    The `playing` case calls `stopPlaybackProgress` (for old ring) AND then starts new progress (via onStarted) for the restarted clip — this is the correct sequence for re-tap-to-restart behavior.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>
      1. Run `npm run dev`, open in browser
      2. Tap a tile with a recording — progress ring should appear centered on the tile, filling as clip plays
      3. Let the clip play to completion — ring should disappear when done
      4. Tap a playing tile — old ring disappears, new ring starts from 0
      5. Check browser console for errors
    </manual>
  </verify>
  <done>
    TypeScript compiles cleanly. `.tile-progress-ring` CSS rule exists. `main.ts` calls `stopPlaybackProgress` in 5 places and `startPlaybackProgress` via `onStarted` in 2 places. `npx tsc --noEmit` exits 0.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Phase 5 visual features on device</name>
  <files></files>
  <action>Human verifies VIZ-01 frequency bars and UX-03 progress ring on real device via ngrok HTTPS tunnel (see how-to-verify below).</action>
  <verify>All 9 verification steps pass — bars animate during recording, ring fills during playback, both clean up correctly.</verify>
  <done>User types "approved" confirming both VIZ-01 and UX-03 work correctly on iPhone Safari.</done>
  <what-built>
    Full Phase 5 implementation: recording frequency bars (VIZ-01) and playback progress ring (UX-03). Both features are integrated in main.ts across all recording and playback paths.
  </what-built>
  <how-to-verify>
    Run `npm run dev` and open the app in a browser (or on iPhone via ngrok for definitive iOS testing — see MEMORY.md for ngrok setup).

    **VIZ-01 — Recording frequency bars:**
    1. Tap an empty tile to start recording
    2. Expected: 12 animated bars appear inside the tile, visibly reacting to ambient sound/voice
    3. Speak into the microphone — bars should change height in response to volume
    4. Tap the recording tile to stop — bars should disappear as tile transitions to "saving"
    5. Verify NO audio echo or feedback heard during recording (no speaker loopback)

    **UX-03 — Playback progress ring:**
    6. Tap a tile with a recording — a semi-transparent white circle ring should appear centered on the tile
    7. Ring should visibly fill (clockwise from top) as the clip plays
    8. When clip ends naturally — ring should disappear, tile returns to has-sound state
    9. Start playback again, then tap the playing tile mid-way — ring disappears immediately, new ring starts from 0%

    **Edge cases:**
    10. Check that the frequency bars overlay the recording tile content (timer, mic icon) and are visible through the semi-transparent bars
    11. Check that the progress ring overlays the playing tile content (play icon, duration badge) without blocking the entire tile

    On iPhone Safari: use ngrok tunnel (`ngrok http 5173`) — microphone requires HTTPS.
  </how-to-verify>
  <resume-signal>Type "approved" if both features work correctly, or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. `npx tsc --noEmit` exits 0
2. `grep -n 'stopPlaybackProgress' src/main.ts | wc -l` returns 5 (all stop paths covered)
3. `grep -n 'startPlaybackProgress' src/main.ts | wc -l` returns 2 (has-sound and playing onStarted)
4. `grep -n 'onStarted' src/audio/player.ts` shows the parameter and the call after source.start(0)
5. `grep -n 'tile-progress-ring' src/style.css` returns the CSS rule
6. `grep -n 'currentTime' src/ui/viz-playback.ts` shows ctx.currentTime used (not Date.now)
</verification>

<success_criteria>
- `src/ui/viz-playback.ts` exists with `startPlaybackProgress` and `stopPlaybackProgress` exports
- `src/audio/player.ts` `playBlob` has optional `onStarted` parameter called after `source.start(0)`
- `.tile-progress-ring` CSS rule in `src/style.css`
- `main.ts` calls `stopPlaybackProgress` in all 5 playback stop paths
- `main.ts` calls `startPlaybackProgress` via `onStarted` in both `has-sound` and `playing` cases
- TypeScript compiles without errors
- Human verification: bars animate during recording, ring fills during playback, both clean up correctly
</success_criteria>

<output>
After completion, create `.planning/phases/05-visual-feedback/05-02-SUMMARY.md` using the summary template at `@/Users/rotmanov/.claude/get-shit-done/templates/summary.md`.

Include in the summary:
- The 5 stopPlaybackProgress call sites in main.ts (exact locations)
- The 2 startPlaybackProgress call sites (via onStarted)
- Confirmation that AudioContext.currentTime is used for elapsed tracking (not Date.now)
- Confirmation that player.ts change is backward-compatible (3-argument callers still work)
- Result of human verification checkpoint (approved/issues found)
</output>
