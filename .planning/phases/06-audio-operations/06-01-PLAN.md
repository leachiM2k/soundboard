---
phase: 06-audio-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/storage/db.ts
  - src/ui/action-sheet.ts
  - index.html
autonomous: true
requirements:
  - TRIM-01
  - SHARE-01

must_haves:
  truths:
    - "SlotRecord type has optional trimStartSec? and trimEndSec? fields loadable from pre-Phase-6 records without error"
    - "Action sheet shows Trim and Export buttons for filled tiles"
    - "onTrim and onExport callbacks are wired in ActionSheetCallbacks and called when the respective buttons are tapped"
  artifacts:
    - path: "src/storage/db.ts"
      provides: "SlotRecord with trimStartSec? and trimEndSec? optional fields"
      contains: "trimStartSec?: number"
    - path: "src/ui/action-sheet.ts"
      provides: "ActionSheetCallbacks with onTrim and onExport; btn-trim and btn-export wired"
      exports: ["showActionSheet", "ActionSheetCallbacks"]
    - path: "index.html"
      provides: "btn-trim and btn-export button elements in #action-sheet dialog"
      contains: "btn-trim"
  key_links:
    - from: "src/ui/action-sheet.ts"
      to: "index.html"
      via: "getElementById('btn-trim') and getElementById('btn-export')"
      pattern: "wireBtn.*btn-trim|wireBtn.*btn-export"
    - from: "src/main.ts"
      to: "src/ui/action-sheet.ts"
      via: "ActionSheetCallbacks.onTrim / ActionSheetCallbacks.onExport"
      pattern: "onTrim|onExport"
---

<objective>
Lay the shared foundation for both Phase 6 features: extend SlotRecord with trim offset fields and add Trim + Export buttons to the action sheet.

Purpose: Both TRIM-01 and SHARE-01 depend on this foundation. Plans 02 and 03 build on these artifacts exclusively (no shared-file conflicts after this plan).
Output: Updated db.ts with trim fields, action-sheet.ts with onTrim/onExport callbacks and wired buttons, index.html with new button elements.
</objective>

<execution_context>
@/Users/rotmanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rotmanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-audio-operations/06-RESEARCH.md

@src/storage/db.ts
@src/ui/action-sheet.ts
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SlotRecord with trim offset fields</name>
  <files>src/storage/db.ts</files>
  <action>
Add two optional fields to the SlotRecord interface in src/storage/db.ts, after the existing `color?` field:

```typescript
/** Trim start offset in seconds. undefined = no trim applied (play from beginning). */
trimStartSec?: number;
/** Trim end offset in seconds. undefined = no trim applied (play to natural end). */
trimEndSec?: number;
```

Follow the exact same optional-field pattern as `color?` and `durationSeconds?`. No migration code needed — undefined fields load cleanly from pre-Phase-6 IndexedDB records (same as color? was added in Phase 4).

Do NOT modify any function signatures or other parts of db.ts.
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1</automated>
    <manual>Confirm trimStartSec and trimEndSec appear in SlotRecord interface with ? modifier</manual>
  </verify>
  <done>tsc --noEmit passes; SlotRecord has trimStartSec?: number and trimEndSec?: number fields</done>
</task>

<task type="auto">
  <name>Task 2: Add Trim and Export buttons to action sheet HTML and TypeScript</name>
  <files>index.html, src/ui/action-sheet.ts</files>
  <action>
**index.html:** Add two new buttons inside `#action-sheet .action-sheet-content`, between `btn-rename` and `btn-delete`. Keep the existing button order (Neu aufnehmen, Umbenennen, then new: Stille kürzen, Exportieren, then existing: Löschen, Farbe section, Abbrechen):

```html
<button class="action-sheet-btn" id="btn-trim">Stille kürzen</button>
<button class="action-sheet-btn" id="btn-export">Exportieren</button>
```

**src/ui/action-sheet.ts:** Extend `ActionSheetCallbacks` interface with two new optional callbacks:

```typescript
export interface ActionSheetCallbacks {
  onReRecord: () => void;
  onRename: () => void;
  onDelete: () => void;
  onColorChange: (color: string | undefined) => void;
  onTrim?: () => void;    // NEW: trigger silence trim
  onExport?: () => void;  // NEW: trigger clip export
}
```

Make `onTrim` and `onExport` optional (?) so existing callers in main.ts continue to compile without changes until Plan 02/03 add the handlers.

In `showActionSheet()`, wire the two new buttons using the existing `wireBtn` clone-before-wire pattern, after the existing `wireBtn('btn-rename', ...)` call and before `wireBtn('btn-delete', ...)`:

```typescript
wireBtn('btn-trim', () => { callbacks.onTrim?.(); });
wireBtn('btn-export', () => { callbacks.onExport?.(); });
```

CRITICAL: Follow the clone-before-wire pattern exactly — wireBtn already handles cloneNode(true) + replaceWith. Do not add inline event listeners directly to the button elements.

Do NOT modify any other callbacks or dialog logic.
  </action>
  <verify>
    <automated>cd /Users/rotmanov/git/private/soundboard && npx tsc --noEmit 2>&1</automated>
    <manual>Open the app in browser, long-press a filled tile — verify "Stille kürzen" and "Exportieren" buttons appear in the action sheet above "Löschen"</manual>
  </verify>
  <done>tsc --noEmit passes; two new buttons visible in action sheet; existing callbacks (onReRecord, onRename, onDelete, onColorChange) unaffected; onTrim/onExport are optional and default to no-op when not provided</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds (Vite build)
- SlotRecord in db.ts has trimStartSec?: number and trimEndSec?: number
- ActionSheetCallbacks in action-sheet.ts has onTrim?: () => void and onExport?: () => void
- index.html has btn-trim and btn-export button elements in correct position
- Existing v1.0/v1.1 SlotRecords without trim fields still load correctly (no runtime errors)
</verification>

<success_criteria>
- tsc --noEmit passes with zero errors
- npm run build succeeds
- Long-pressing a filled tile shows "Stille kürzen" and "Exportieren" buttons in the action sheet
- Tapping either new button closes the sheet without errors (callbacks are no-ops until Plans 02/03 wire them)
- All existing action sheet behavior (re-record, rename, delete, color, cancel) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/06-audio-operations/06-01-SUMMARY.md` using the summary template.
</output>
